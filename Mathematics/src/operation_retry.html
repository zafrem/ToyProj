<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <div id="header-container"></div>
  <h1>ğŸ“Œ í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°</h1>
  <div id="retry-container"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-init.js"></script>
  <script>
    fetch("./header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("header-container").innerHTML = html;
        const script = document.createElement("script");
        script.src = "../js/auth-handler.js";
        document.body.appendChild(script);
      });
  </script>
  <script>
    const retryContainer = document.getElementById("retry-container");

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        retryContainer.innerHTML = "<p>ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</p>";
        return;
      }

      firebase.firestore()
        .collection("wrongProblems")
        .doc(user.uid)
        .collection("list")
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            retryContainer.innerHTML = "<p>í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "retry-problem";
            div.innerHTML = `
              <div class="retry-problem-body">
                <span>${data.problem.a} ${data.problem.operator} ${data.problem.b} =</span>
                <input type="number" data-id="${doc.id}" data-ans="${data.correct}" />
              </div>
              <div class="retry-problem-header">
                <button onclick="checkAnswer('${doc.id}', ${data.correct})">ì •ë‹µ í™•ì¸</button>
              </div>
            `;

            retryContainer.appendChild(div);
          });
        });
    });

    function checkAnswer(id, correctAnswer) {
      const input = document.querySelector(`input[data-id="${id}"]`);
      const value = input.value.trim();
      if (parseInt(value) === correctAnswer) {
        const confirmDelete = confirm("ì •ë‹µì…ë‹ˆë‹¤! ì´ ë¬¸ì œë¥¼ ì‚­ì œí• ê¹Œìš”?");
        if (confirmDelete) {
          const user = firebase.auth().currentUser;
          firebase.firestore()
            .collection("wrongProblems")
            .doc(user.uid)
            .collection("list")
            .doc(id)
            .delete()
            .then(() => {
              alert("ì‚­ì œ ì™„ë£Œ!");
              input.parentElement.parentElement.remove();
            });
        }
      } else {
        alert("í‹€ë ¸ì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!");
      }
    }
  </script>
</body>
</html>
