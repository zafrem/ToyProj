<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>틀린 문제 다시 풀기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <div id="header-container"></div>
  <h1>📌 틀린 문제 다시 풀기</h1>
  <div id="retry-container"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-init.js"></script>
  <script>
    fetch("./header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("header-container").innerHTML = html;
        const script = document.createElement("script");
        script.src = "../js/auth-handler.js";
        document.body.appendChild(script);
      });
  </script>
  <script>
    const retryContainer = document.getElementById("retry-container");

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        retryContainer.innerHTML = "<p>로그인 후 이용해주세요.</p>";
        return;
      }

      firebase.firestore()
        .collection("wrongProblems")
        .doc(user.uid)
        .collection("list")
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            retryContainer.innerHTML = "<p>틀린 문제가 없습니다.</p>";
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "retry-problem";
            div.innerHTML = `
              <div class="retry-problem-body">
                <span>${data.problem.a} ${data.problem.operator} ${data.problem.b} =</span>
                <input type="number" data-id="${doc.id}" data-ans="${data.correct}" />
              </div>
              <div class="retry-problem-header">
                <button onclick="checkAnswer('${doc.id}', ${data.correct})">정답 확인</button>
              </div>
            `;

            retryContainer.appendChild(div);
          });
        });
    });

    function checkAnswer(id, correctAnswer) {
      const input = document.querySelector(`input[data-id="${id}"]`);
      const value = input.value.trim();
      if (parseInt(value) === correctAnswer) {
        const confirmDelete = confirm("정답입니다! 이 문제를 삭제할까요?");
        if (confirmDelete) {
          const user = firebase.auth().currentUser;
          firebase.firestore()
            .collection("wrongProblems")
            .doc(user.uid)
            .collection("list")
            .doc(id)
            .delete()
            .then(() => {
              alert("삭제 완료!");
              input.parentElement.parentElement.remove();
            });
        }
      } else {
        alert("틀렸어요. 다시 시도해보세요!");
      }
    }
  </script>
</body>
</html>
